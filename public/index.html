<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lenskart On-Call System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .TRIGGERED { border-left: 6px solid #dc3545; background: #fff5f5; }
        .ACKNOWLEDGED { border-left: 6px solid #ffc107; background: #fffbf0; }
        .RESOLVED { border-left: 6px solid #198754; background: #f0fdf4; opacity: 0.7; }
        .card { margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-light p-4">
    <div class="container">
        <h1 class="mb-4">ðŸ”¥ Lenskart Incident Manager</h1>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card p-3">
                    <h5>ðŸ›  Setup Rotation (Admin)</h5>
                    <input type="text" id="polService" class="form-control mb-2" placeholder="Service (e.g., Database)">
                    <input type="text" id="polUser" class="form-control mb-2" placeholder="Primary On-Call Name">
                    <input type="email" id="polEmail" class="form-control mb-2" placeholder="Email">
                    <button onclick="createPolicy()" class="btn btn-primary w-100">Create Policy</button>
                </div>

                <div class="card p-3 mt-3">
                    <h5>ðŸš¨ Trigger Alert (External)</h5>
                    <input type="text" id="alertService" class="form-control mb-2" placeholder="Service Name">
                    <textarea id="alertDesc" class="form-control mb-2" placeholder="Error Details (e.g. 500 Error)"></textarea>
                    <button onclick="triggerIncident()" class="btn btn-danger w-100">ðŸ”¥ Trigger Incident</button>
                </div>
            </div>

            <div class="col-md-8">
                <h3>Live Incidents</h3>
                <div id="incidentList">
                    </div>
            </div>
        </div>
    </div>

    <script>
        const API = 'http://localhost:3000/api';

        async function loadDashboard() {
            const res = await fetch(`${API}/dashboard`);
            const data = await res.json();
            const list = document.getElementById('incidentList');
            list.innerHTML = '';

            data.incidents.forEach(inc => {
                const buttons = inc.status !== 'RESOLVED' ? `
                    <div class="mt-2">
                        <button onclick="updateStatus('${inc.id}', 'ack')" class="btn btn-sm btn-warning">Acknowledge</button>
                        <button onclick="updateStatus('${inc.id}', 'resolve')" class="btn btn-sm btn-success">Resolve</button>
                    </div>` : '<span class="badge bg-success">Fixed</span>';

                const html = `
                    <div class="card p-3 ${inc.status}">
                        <div class="d-flex justify-content-between">
                            <h4>${inc.service_name}</h4>
                            <span class="badge bg-secondary">${inc.status}</span>
                        </div>
                        <p>${inc.description}</p>
                        <small class="text-muted">Assigned to: <strong>${inc.assigned_to}</strong></small>
                        ${buttons}
                    </div>`;
                list.innerHTML += html;
            });
        }

        async function createPolicy() {
            const service = document.getElementById('polService').value;
            const name = document.getElementById('polUser').value;
            const email = document.getElementById('polEmail').value;

            await fetch(`${API}/policy`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    service_name: service,
                    people: [{ name, email, phone: "9999999999" }]
                })
            });
            alert('Policy Created!');
            loadDashboard();
        }

        async function triggerIncident() {
            const service = document.getElementById('alertService').value;
            const desc = document.getElementById('alertDesc').value;

            const res = await fetch(`${API}/incident`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ service_name: service, description: desc })
            });

            if(res.ok) {
                loadDashboard();
            } else {
                alert('Error: No On-Call Policy found for this service!');
            }
        }

        async function updateStatus(id, type) {
            await fetch(`${API}/incident/${id}/${type}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: "DevOps_Engineer" })
            });
            loadDashboard();
        }

        // Auto-load on start
        loadDashboard();
    </script>
</body>
</html>